# Avito-merch-shop
Тестовое задание для стажёра Backend-направления (зимняя волна 2025)

## Описание
В Авито существует внутренний магазин мерча, где сотрудники могут приобретать товары за монеты (coin). Каждому новому сотруднику выделяется 1000 монет, которые можно использовать для покупки товаров. Кроме того, монеты можно передавать другим сотрудникам в знак благодарности или как подарок. Этот проект представляет собой реализацию данного магазина мерча.

## Функционал
✅ Авторизация с помощью JWT

✅ Покупка мерча

✅ Обмен монетками между пользователями

✅ Кэширование Redis

✅ Rate Limiter

## Используемый стек
- Python 3.11.5
- FastAPI
- PostgreSQL
- Redis
- Alembic
- SQLAlchemy v2
- Pydantic v2
- Docker
- Locust
- PyTest

## Инструкция по запуску
1. Клонируем репозиторий и переходим в целевую папку:

```
git clone https://github.com/valkievan/Avito-merch-shop.git
cd Avito-merch-shop
```

2. Собираем и запускаем контейнер:

```
docker compose up --build
```
Миграции применяются автоматически во время запуска контейнера

*После запуска API будет доступен по адресу: http://localhost:8080*
## Тесты
Для тестирования используется фреймворк **Pytest**. Суммарное тестовое покрытие проекта составляет **77%**. Это также отражено в файле coverage.txt.
Unit-тесты находятся в папке tests/test_api;
Интеграционные тесты на сценарии покупки мерча, передачи монеток другим сотрудникам и т.д. находятся в папке tests/test_e2e
### Запуск тестов
```
docker compose exec app pytest tests -v
```
Результат:

![image](https://github.com/user-attachments/assets/e2302e4e-db81-4438-8301-2e87970e3a1c)
### Запуск тестов с покрытием кода
```
docker compose exec app pytest --cov=app --cov-report=term-missing 
```
Результат:

![image](https://github.com/user-attachments/assets/14ea2b85-8e89-41e8-aa34-d90075ae8323)

## Нагрузочное тестирование

Чтобы справиться с большим количеством запросов от пользователей, был реализован middleware с ограничителем запросов и защитой от флуда.

**Rate Limiter**:
- Разные лимиты для разных эндпоинтов
- Для хранения счетчиков используется Redis
- Скользящее окно для подсчета запросов
- Добавление headers с информацией о лимитах

**Защита от флуда**:
- Подсчет ошибок в отдельном временном окне
- Автоматический бан на 5 секунд при превышении лимита ошибок
- Учет ошибок только для 4xx и 5xx ответов

Для проведения нагрузочного тестирования используется фреймворк Locust

### Запуск нагрузочного тестирования осуществляется командой:
```
docker compose exec app locust -f tests/locustfile.py --host=http://localhost:8080
```
*После этого Locust будет доступен по адресу: http://localhost:8089*

В интерфейсе фреймворка нужно указать количество пользователей и spawn rate. Параметр host можно не менять, т.к. он автоматически подставится после ввода команды выше

Результат:

![image](https://github.com/user-attachments/assets/6a6557b9-4d10-482f-9348-72845012aa7a)

![total_requests_per_second_1739731599 953](https://github.com/user-attachments/assets/387621c1-facf-4890-87b3-83bfa65c152f)

Полученные данные подтверждают, что проект хорошо справляется с умеренной нагрузкой. 

## Линтер
В проекте использутеся линтер **ruff**. Описание конфигурации линтера находится в файле pyproject.toml. При необходимости, можно запустить линтер вручную командой:
```
docker compose exec app ruff check .
```
Результат:

![image](https://github.com/user-attachments/assets/92559577-6c16-4343-953a-18d1384d6064)

Как видно на скриншоте, линтер после первого запуска нашёл 57 ошибок (которые были специально сделаны для демонстрации :blush:) и успешно устранил их. После второго запуска **ruff**, все проверки были с лёгкостью пройдены.
